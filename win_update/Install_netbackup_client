# netback install yml 
---
- hosts: all
  vars: 
       site: 'rtp'
  tasks:


    - name: add site to txt file
      win_shell: Set-Content -Path C:\flats\site.txt -Value '{{ site }}'

    - name: install netbackup client 
      win_chocolatey:
           name: netbackup
           state: present





############   chocolateyinstall.ps1 Exp 1 ###########
$site = Get-Content -Path C:\as\sites.txt 

If ($site -eq 'rtp') {c:\as\rtp.cmd}
ElseIf  ($site -eq 'Alln') {c:\as\rtp.cmd}
ElseIf ($site -eq 'rcd') {c:\as\rtp.cmd}
Else {default.cmd}

############   chocolateyinstall.ps  Exp 2 ###########

#$packageName = 'netbackup'

$scriptPath =  $(Split-Path $MyInvocation.MyCommand.Path)
#$fileFullPath = Join-Path -path "$scriptPath" -childpath "\netbackup\64"
$fileFullPath = Join-Path $scriptPath  '\netbackup\64'

$site = Get-Content -Path C:\as\sites.txt

If ($site -eq "rtp") {cmd /c "$fileFullPath\rtp.cmd"}
    Else ($site -eq "allen") {cmd /c "$fileFullPath\allen.cmd"}
    Else ($site -eq "sjc") {cmd /c "$fileFullPath\sjc.cmd"}
 ElseIf ($site -eq "rcd") {cmd /c "$fileFullPath\rcd.cmd"}
Else {cmd /c "$fileFullPath\default.cmd"}




# tasks file for win_netbackup  latest

- name: download file to local folder
win_get_url:
   url: 'https://wwwin-repomgmt-nprd.cisco.com/chocolatey/7zpkg.1.0.0.nupkg'
   dest: 'c:\flats'
#       remote_src: True
- name: unzip files at path "c:\flats\netbackup\x64'
win_shell:
         |
           expand-archive -path 'c:\flats\netbackup.zip' -destinationpath 'c:\flats\netbackup'
- name: add variables (masterservername, mediaservers, token no  to silentclient file
win_lineinfile:
  path   : 'C:\flats\netbackup\64\SilentCLientcmd_SJC.cmd'
  regex : "{{ item.regex }}"
  insertafter: '^REM netbackup'
  line: "{{ item.line }}"
with_items:
  - {  regex: '(^MASTERSERVER=)', line: 'SET MASTERSERVER={{ masterserver_name }}'}
  - {  regex: '<token>',   line: 'SET ADDITIONALSERVERS={{ media_servers }}'}
  - {  regex: '<token>',   line: 'SET AUTHORIZATION_TOKEN={{ token_no }}'}

- name: Run setup execution
win_command: cmd.exe -
args:
     chdir: 'c:\flats\netbackup\64\'
     stdin: 'silentclient.cmd'
- name: Pause for 10 minutes to complete setup
pause:
 minutes: 3

- name: Remove a file, if present
win_file:
  path: 'c:\flats\netbackup.zip'
  state: absent

- name: Remove directory, if present
win_file:
 path: 'c:\flats\netbackup\64'
 state: absent
~                                                                                                                                                                                                           
~                        